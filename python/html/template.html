{# template.html #}

<!DOCTYPE html>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">

{# Force background-color to print, for use with print to pdf (used in headers) #}
<style>
  body{
    -webkit-print-color-adjust:exact !important;
    print-color-adjust:exact !important;
  }
</style>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Results</title>
</head>

<body>

{#  Structure:
    - Intro section with list of all requirements tested
    - Subsequent sections for each requirement tested
      - List of steps for each requirement
      - Screenshots for each step when relevant

    ... Are we basing these requirements off the 25 thu-mai provided, or the walkthrough she emailed
    ... ... I think we are doing the 25 provided, I'll break out the pieces of her workflow



#}

{# TODO: add RDMC logo when one exists #}
<h1>{{text.document_title}}</h1>
<p>{{text.document_description}}</p>

<hr>
<h2>Test Info</h2>
{# <p>Dataverse URL: {{info.dv_url}}</p>
<p>Dataverse Version: {{info.dv_version}}</p>
<p>Browser Version: {{info.browser_version}}</p>
<p>Test User: {{info.test_user}}</p> #}
<table>
<tr>
<td>Dataverse URL:</td>
<td>{{info.dv_url}}</td>
</tr>
<tr>
<td>Dataverse Version:&nbsp;&nbsp;&nbsp;</td>
<td>{{info.dv_version}}</td>
</tr>
<tr>
<td>Browser Version:</td>
<td>{{info.browser_version}}</td>
</tr>
<tr>
<td>Test User:</td>
<td>{{info.test_user}}</td>
</tr>
<tr>
<td>Test Date:</td>
<td>{{info.test_date}}</td>
</tr>
</table>

<hr>
<h2>Results</h2>

{% set tested_reqs = [1,2,3,4,5,6,9,10,11,12,13,14,15,16,17,18,20,21,22,23,24] %}

{% for req in tested_reqs %}
  {% for key, value in text.items() %}
    {% if key.startswith('r' + ('%02d' % req) + '_title') %}
      {% if index_with_default(test_order, req) > index_with_default(test_order, last_req) or (req == last_req and failure == True) %}
        <p><i class="fa-solid fa-circle-xmark" style="color: #c91c1c;"></i> {{value}}</p>
      {% else %}
        <p><i class="fa-solid fa-circle-check" style="color: #008e00;"></i> {{value}}</p>
      {% endif %}
    {% endif %}
  {% endfor %}
{% endfor %}

{# TODO: try adding page breaks at the end of each section for when we print to pdf. Start at https://stackoverflow.com/questions/42005819/ #}

{% for req in tested_reqs %} {# range(1, 25) #}
  <br/>{# remove after page break? #}
  {# TODO: Round "PASS" text corners #}

  {% if index_with_default(test_order, req) > index_with_default(test_order, last_req) or (req == last_req and failure == True) %}
    <div><h2 style="display:inline-block;">{{text['r' + ('%02d' % req) + '_title']}} </h2>&nbsp;&nbsp;<h4 style="position:relative; top: -6px; padding: 3px 3px 0px 3px; display:inline-block; background-color: #c91c1c; color: #ffffff; border-radius: 4px;">FAIL</h4></div>
  {% else %}
    <div><h2 style="display:inline-block;">{{text['r' + ('%02d' % req) + '_title']}} </h2>&nbsp;&nbsp;<h4 style="position:relative; top: -6px; padding: 3px 3px 0px 3px; display:inline-block; background-color: #008e00; color: #ffffff; border-radius: 4px;">PASS</h4></div>
  {% endif %}

  {% if req in end_times %}
  <table>
    <tr>
      <td><i class="fa-regular fa-calendar-days"></i> Date/Time:&nbsp;&nbsp;</td>
      <td>{{ datetime.fromtimestamp(end_times[req]).strftime('%B %e, %Y %H:%M') }}</td>
    </tr>
    <tr>
      <td><i class="fa-regular fa-clock"></i> Duration:</td>
      <td>{{'%0.1f' % (end_times[req]-start_times[req])}} seconds</td>
    </tr>
  </table>
  {% endif %}
  <hr>
  {% for key, value in text.items() %}
    {% if key.startswith('r' + ('%02d' % req) + '_p') %}
      {% set part = key[-2:] | int %}
      {% if index_with_default(test_order, req) > index_with_default(test_order, last_req) or (req == last_req and part > last_part) or (req == last_req and part == last_part and failure == True) %}
        <p><i class="fa-solid fa-circle-xmark" style="color: #c91c1c;"></i> {{value}}</p>
      {% else %}
        <p><i class="fa-solid fa-circle-check" style="color: #008e00;"></i> {{value}}</p>
      {% endif %}
      <div style="margin-left: 7px;">
        {# We have to do make our count an object to deal with scoping issues in jinja #}
        {% set count = namespace(value=0) %}
        {# We first count how many screenshots #}
        {% for name in screenshots.keys() %}
          {% if name.startswith(key) %}
            {% set count.value = count.value + 1 %}
          {% endif %}
        {% endfor %}
        {# Then we display each screenshot in a div #}
        {% for index in range(1, count.value + 1) %}
          <div style="display: inline-block; margin: 10px;">
            <img src="data:image/jpeg;base64,{{screenshots.get(key + '_s' + ('%02d' % index)) | safe}}" width="208" height="117" />
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endfor %}
{% endfor %}

</body>
</html>
